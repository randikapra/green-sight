# ============================================================
# GreenSight - Central Configuration
# ============================================================
# Multi-city urban green space monitoring across Sri Lanka
# Override with: python scripts/train.py --config configs/custom.yaml
# ============================================================

# --- Project ---
project:
  name: "GreenSight"
  description: "Deep Learning-Based Urban Green Space Monitoring Using Sentinel-2 — A Multi-City Study in Sri Lanka"
  seed: 42
  device: "auto"
  num_workers: 4
  output_dir: "./results"
  log_dir: "./logs"

# --- Google Earth Engine ---
gee:
  project_id: "paper-automation-466307"

# --- Study Areas ---
# 4 cities spanning all major climate zones of Sri Lanka
# Thresholds are auto-computed via Otsu multi-threshold per city
study_areas:
  colombo:
    name: "Colombo"
    description: "Tropical wet, highly urbanized capital"
    climate_zone: "Wet Zone"
    bounds: [79.82, 6.85, 79.92, 6.98]
    num_classes: 4
    classes:
      0: { name: "Water",         ndvi_max: 0.05,  color: "#2196F3" }
      1: { name: "Built-up",      ndvi_min: 0.05,  ndvi_max: 0.25,  color: "#9E9E9E" }
      2: { name: "Barren/Sparse", ndvi_min: 0.25,  ndvi_max: 0.45,  color: "#FFC107" }
      3: { name: "Green Space",   ndvi_min: 0.45,  ndvi_max: 0.95,  color: "#4CAF50" }

  kandy:
    name: "Kandy"
    description: "Hill capital, intermediate zone, cultural center"
    climate_zone: "Intermediate Zone"
    bounds: [80.59, 7.26, 80.69, 7.33]
    num_classes: 4
    classes:
      0: { name: "Water",         ndvi_max: 0.05,  color: "#2196F3" }
      1: { name: "Built-up",      ndvi_min: 0.05,  ndvi_max: 0.35,  color: "#9E9E9E" }
      2: { name: "Barren/Sparse", ndvi_min: 0.35,  ndvi_max: 0.65,  color: "#FFC107" }
      3: { name: "Green Space",   ndvi_min: 0.65,  ndvi_max: 0.95,  color: "#4CAF50" }

  hambantota:
    name: "Hambantota"
    description: "Southern dry zone, rapid infrastructure development"
    climate_zone: "Dry Zone"
    bounds: [81.08, 6.10, 81.18, 6.20]
    num_classes: 4
    classes:
      0: { name: "Water",         ndvi_max: 0.05,  color: "#2196F3" }
      1: { name: "Built-up",      ndvi_min: 0.05,  ndvi_max: 0.25,  color: "#9E9E9E" }
      2: { name: "Barren/Sparse", ndvi_min: 0.25,  ndvi_max: 0.55,  color: "#FFC107" }
      3: { name: "Green Space",   ndvi_min: 0.55,  ndvi_max: 0.95,  color: "#4CAF50" }

  jaffna:
    name: "Jaffna"
    description: "Northern arid zone, post-conflict reconstruction"
    climate_zone: "Arid Zone"
    bounds: [79.98, 9.63, 80.08, 9.73]
    num_classes: 4
    classes:
      # 0: { name: "Water",         ndvi_max: 0.05,  color: "#2196F3" }
      # 1: { name: "Built-up",      ndvi_min: 0.05,  ndvi_max: 0.25,  color: "#9E9E9E" }
      # 2: { name: "Barren/Sparse", ndvi_min: 0.25,  ndvi_max: 0.45,  color: "#FFC107" }
      # 3: { name: "Green Space",   ndvi_min: 0.45,  ndvi_max: 0.95,  color: "#4CAF50" }
      0: { name: "Water",         ndvi_max: 0.10,  color: "#2196F3" }  # Wider water
      1: { name: "Built-up",      ndvi_min: 0.10,  ndvi_max: 0.30,  color: "#9E9E9E" }
      2: { name: "Barren/Sparse", ndvi_min: 0.30,  ndvi_max: 0.55,  color: "#FFC107" }
      3: { name: "Green Space",   ndvi_min: 0.55,  ndvi_max: 0.95,  color: "#4CAF50" }  # Much stricter!

# --- Data Collection ---
data:
  source: "COPERNICUS/S2_SR_HARMONIZED"
  bands: ["B2", "B3", "B4", "B8"]
  max_cloud_pct: 20
  raw_dir: "./data/raw"
  processed_dir: "./data/processed"

  periods:
    - label: "2019"
      start: "2019-01-01"
      end: "2019-03-31"
    - label: "2025"
      start: "2025-01-01"
      end: "2025-03-31"

# --- Preprocessing ---
preprocessing:
  patch_size: 64
  stride: 32
  min_valid_ratio: 0.8
  min_label_confidence: 0.35
  adaptive_thresholds: false    # Legacy percentile method (disabled)
  otsu_thresholds: true         # Otsu multi-threshold from combined periods (recommended)

  split:
    test_size: 0.15
    val_size: 0.15

# --- Training ---
training:
  batch_size: 32
  num_epochs: 50
  early_stopping_patience: 10

  optimizer:
    name: "adamw"
    lr: 1.0e-4
    weight_decay: 1.0e-4

  scheduler:
    name: "cosine"
    step_size: 15
    gamma: 0.1

  augmentation:
    horizontal_flip: true
    vertical_flip: true
    random_rotation: true
    brightness_jitter: 0.1

  eval_interval: 5
  save_every: 10
  log_train_metrics_every: 1

# --- Models ---
models:
  resnet50:
    enabled: true
    backbone: "resnet50"
    pretrained: true
    freeze_layers: ["layer1", "layer2"]
    input_adapt: "conv1"

  vit_small:
    enabled: true
    backbone: "vit_small_patch8_224"
    pretrained: true
    img_size: 64
    input_adapt: "adapter"

  efficientnet_b0:
    enabled: true
    backbone: "efficientnet_b0"
    pretrained: true
    input_adapt: "conv_stem"

  swin_tiny:
    enabled: true
    backbone: "swin_tiny_patch4_window7_224"
    pretrained: true
    img_size: 64
    input_adapt: "adapter"

  convnext_tiny:
    enabled: true
    backbone: "convnext_tiny"
    pretrained: true
    input_adapt: "stem.0"

# --- Temporal Analysis ---
temporal:
  prediction_stride: 32
  prediction_batch_size: 64
  pixel_size_m: 10
  best_model: "auto"
  min_prediction_confidence: 0.70  # Filter low-confidence predictions
  change_detection:
    flag_threshold_pct: 30  # Flag changes > ±30%
    reject_threshold_pct: 100  # Auto-reject changes > ±100% (data error)
    min_confidence_for_change: 0.75  # Higher confidence for change detection

# --- Multi-GPU ---
distributed:
  enabled: false
  gpu_ids: [0, 1]